(window.MIP=window.MIP||[]).push({name:"mip-qqtn-msg",func:function(){define("mip-qqtn-msg/mip-qqtn-msg",["require","zepto","customElement"],function(e){function t(){var e=n(".w-text textarea").val(),t=e.length,i=e.replace(/[\x00-\xff]/g,"").length;if(Math.ceil((t+i)/2)<5)n("#verify").addClass("disable");else n("#verify").removeClass("disable")}function i(e){function i(e){var t="";return t+=[e.getFullYear(),e.getMonth()+1,e.getDate()].join("/"),t.replace(/(-|\:)(\d[^\d])/g,"$10$2")}function r(e,t){var i=new Date;i.setTime(i.getTime()+12e4),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()}function s(e){var t,i=new RegExp("(^| )"+e+"=([^;]*)(;|$)");if(t=document.cookie.match(i))return unescape(t[2]);else return null}function l(){v=m.find("li");var e=n(".w-text textarea").val();if(n("#submit #verify").hasClass("disable"))return alert("您评论写的太短啦！"),!1;else if(1===s("oldTime"+g))return alert("您评论次数太频繁啦！"),!1;fetch(o+"ajax.asp?Action=2&SoftID="+g+"&content="+e+"&CommentTpye="+a).then(function(e){return e.text()}).then(function(e){var t='<li><p class="user">您发表的跟贴<time><font color="red">'+i(new Date)+"</font></time></p><p>"+n(".w-text textarea").val()+"<p></li>";return 0===v.length?m.html(t):v.first().before(t),n("#comment #submit").hide(),n("#view-comment").show(),n(".w-text textarea").val("").focus(),r("oldTime"+g,"1"),alert("提交成功！"),!1}).catch(function(e){})}function c(){n("#comment-list li .u-huifu").click(function(){n("#submit").css("display","block"),n(".post .fb").css("display","none");var e=n(this).attr("pid");n(".w-text textarea").text("[quote]"+e+"[/quote]").focus(),n("#cancel").click(function(){n(".w-text textarea").text(""),n(".post .fb").css("display","block")})})}function d(e,t,i){var r=n("#comment-list li span");if(0===r.length)return!1;for(var a=0;a<r.length;a++){var o=r.eq(a).find("a").first();r.eq(a).find("em");o.click(function(){u(n(this).parent().attr("id"));var e=n(this).parent().find("em");e.html(parseInt(e.html(),0)+1),n(this).unbind(),n(this).attr("title","您已经顶过了")})}p(e,t,i)}function u(e){var t="action=19&id="+e;n.ajax({type:"POST",url:"https://m.qqtn.com/ajax.asp",data:t,success:function(e){}})}function p(e,t,i){for(var r=n("#comment-list li span"),o="",s=0;s<r.length;s++)if(o+=r.eq(s).attr("id"),s<r.length-1)o+=",";if(""!==o){var l="action=18&id="+g+"&CommentTpye="+a+"&sendid="+escape(o);n.ajax({type:"POST",url:"https://m.qqtn.com/ajax.asp",data:l,success:function(t){f(e,t)}})}}function f(e,t){for(var i=n("#comment-list li span"),r=new Function("return"+t)(),a=0;a<i.length;a++)for(var o=i.eq(a).find("em"),s=i.eq(a).attr("id"),l=0;l<r.ID.length;l++)if(s===r.ID[l].toString()){o.html(r.Ding[l]);break}}function h(){v=m.find("li"),y=Math.floor(v.length/5+1),fetch(o+"sajax.asp?action=6&t="+g+"&s="+a+"&num=5&p="+y).then(function(e){return e.text()}).then(function(e){for(var t="",e=new Function("","return"+e)(),i=e.user,r=(e.sUserFrom,e.DateAndTime),a=e.Excerpt,o=e.Graded,s=0;s<i.length;s++)t+='<li><p class="user">腾牛网友<time>'+r[s]+"</time><i>第"+o[s]+"楼</i></p><p>"+decodeURIComponent(a[s])+'</p><span class="u-click" id="'+e.Id[s]+'"><a href="javascript:">支持(<em>0</em>)</a><a class="u-huifu" href="javascript:" pid="'+e.Id[s]+'">盖楼(回复)</a></span></li>';if(e.RecordCount>5)n("#view-comment .button-status-complete").css("display","block"),n("#comment .button").show();if(y>=e.PageCount)n("#view-comment .button").text("没有更多评论了！").unbind("click");0===v.length?m.html(t):v.last().after(t),n("#comment-list li h4").hide(),c(),d(g)}).catch(function(e){})}var m=n("#comment-list"),g=n("#app-id").val(),v=m.find("li"),y=Math.floor(v.length/5+1),g=n("#app-id").val();n("#submit #verify").click(function(){return l(),!1}),h(),n("#view-comment .button").bind("click",function(){h()}),n("#view-comment header .fb").click(function(){n("#view-comment").css("display","none"),n("#submit").css("display","block")}),n("#cancel").click(function(){n("#view-comment").css("display","block"),n("#submit").css("display","none")}),n(".w-text textarea").keyup(t)}var n=e("zepto"),r=e("customElement").create(),a=n(".f-information").attr("data-CommentTpye"),o=n("#comment").find("mip-form").attr("url");return r.prototype.build=function(){i(this.element)},r}),define("mip-qqtn-msg",["mip-qqtn-msg/mip-qqtn-msg"],function(e){return e}),function(){function e(e,t){e.registerMipElement("mip-qqtn-msg",t)}if(window.MIP)require(["mip-qqtn-msg"],function(t){e(window.MIP,t)});else require(["mip","mip-qqtn-msg"],e)}()}});